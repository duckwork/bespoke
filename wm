#! /usr/bin/env dash
# WM 0.1
# by Case Duckworth

hi() 
{ # setup variables, files, and directories
  # export WMD="${XDG_CONFIG_HOME:-$HOME/.config}/wm"
  export WMD="$HOME/projects/wm";
  export LIB="$WMD/lib";
  export BIN="$WMD/bin";
  export HOOKS="$WMD/hooks";
  mkdir -p $WMD $BIN $LIB ;

  export TMP="/tmp/wm";
  mkdir -p $TMP;
}

edit()
{
  file="$1";
  if [ -w "$file" ] || [ ! -f "$file" ]; then
    $EDITOR $file;
  else
    die $E_FNF "\"$file\" is not writable"
  fi
}

# Local utilities
runf()
{ # runf <cmd> <args>
  f="$1"; shift;
  case "$1" in
    0x*) wid="$1" ;;
    *)
      [ $# -ge 2 ] || die $E_ARG "Not enough arguments"
      cmd="$BIN/$1"; shift;
      if [ -x "$cmd" ]; then
        wid="$($cmd $@)";
      else
        die $E_EXE "Unknown command: \"$cmd\"";
      fi
      ;;
  esac
  logx $f $wid;
}

# Atomic actions
focus() 
{ # focus a window
  # . $LIB/config.sh
  focus_wid() {
    # oldw=$(pfw);
    if wattr "$1"; then
      wtf "$1";
      chwso -r "$1";
      # set_borders "$w" "$1";
    fi
  }
  runf focus_wid "$@";
}

map()
{ # map a window
  map_wid() {
    if wattr "$1" && ! wattr m "$1"; then
      mapw -m "$1";
      focus "$1";
    fi
  }
  runf map_wid "$@";
}

hide()
{ # unmap a window
  hide_wid() {
    if wattr "$1" && wattr m "$1"; then
      mapw -u "$1";
      # TODO deal with focus
    fi
  }
  runf hide_wid "$@";
}

ignore()
{ # set a window's override_redirect property
  ignore_wid() {
    if wattr "$1" && ! wattr o "$1"; then
      ignw -s "$1";
      # TODO deal with focus
    fi
  }
  runf ignore_wid "$@";
}

notice()
{ # unset a window's override_redirect property
  notice_wid() {
    if wattr "$1" && wattr o "$1"; then
      ignw -r "$1";
      focus "$1";
    fi
  }
  runf notice_wid "$@";
}

raise()
{ # raise a window to the top of the stack
  raise_wid() {
    if wattr "$1"; then
      chwso -r "$1";
      focus "$1";
    fi
  }
  runf raise_wid "$@";
}

lower()
{ # lower a window to the bottom of the stack
  lower_wid() {
    if wattr "$1"; then
      chwso -l "$1";
      # TODO deal with focus
    fi
  }
  runf lower_wid "$@";
}

#####################################################################
main() 
{
  [ $# -ge 1 ] || die $E_ARG "Not enough arguments";
  cmd="$1"; shift;
  case "$cmd" in
    focus|raise|lower|map|hide|ignore|notice|raise|lower) 
      # built-in commands
      $cmd $@;
      ;;
    *) # other scripts
      cmd="$BIN/$cmd";
      if [ -x "$cmd" ]; then
        $cmd $@;
      elif [ -f "$cmd" ]; then # TODO take this out when finished
        chmod +x "$cmd"
        $cmd $@;
      else
        die $E_EXE "\"$cmd\" is unavailable";
      fi
      ;;
  esac
}

bespoke()
{ # ln -s ./wm $PATH/bespoke ; startx bespoke
  wm stack nuke;
  sxhkd -c $WMD/keys || {
    read pid <$TMP/keyd.pid;
    kill -SIGUSR1 $pid;
  } &
  echo $! > $TMP/keyd.pid
  wm bait &
  wait;
}

hi;
. $LIB/util.sh
export WMVERBOSE=false; WMQUIET='';
while getopts vqle:i: opt; do
  case $opt in
    v) # verbose
      export WMVERBOSE=true;
      ;;
    q) # quiet
      WMQUIET=silent;
      ;;
    l) # list commands
      ls $BIN;
      exit $?;
      ;;
    e) # edit command
      edit "$BIN/$OPTARG";
      exit $?;
      ;;
    \?) die $E_ARG "Unknown option \"$opt\"" ;;
  esac
done; shift $((OPTIND - 1));

case $0 in
  *bespoke) $WMQUIET bespoke ;;
  *) $WMQUIET main $@        ;;
esac
